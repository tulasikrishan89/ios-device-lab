<!DOCTYPE html>
<html lang="en">
<head>
    <title>ios Device control</title>
</head>
<body>
    <div class="wrapper">
        <section class="content">

            <!-- <div class="col-sm-10 col-md-6"> -->
                <div class="box box-success">

                    <div style="text-align:center;">
                      <span id="ScreenCoordinates">(0, 0)</span>
                    </div>
                    <!-- <span class="finger finger-0" style="transform: translate3d(0, 0, 0)"></span>
                    <span class="finger finger-1"></span> -->
                    <div  style="margin:0 auto;width:360px;" onmousemove="ScreenCoordinates(event)" onmouseout="clearCoor()">
                        <!-- <canvas id="screen" style="border: 1px solid red;"  width="300" height="600"></canvas> -->
                        <img id="screen" style="-webkit-user-select: none;margin: auto;" src="http://169.254.211.6:9100/" width="375" height="667">
                    </div>
                    <!-- <div class="btn-home">
                        <span id="home" class="btn btn-success" onclick="home()">Home</span>
                    </div> -->

                </div>
            <!-- </div> -->
        </section>
      </div>

<script>
    var canvas, ctx, $shot,$save,$imgs;
    var imgType = 'png', imgW = 414, imgH = 736, imgX = 0, imgY = 0;
    function init () {
        canvas = document.getElementById('screen');
        ctx = canvas.getContext('2d');
        $shot = document.getElementById('shot');
        $save = document.getElementById('save');
        $imgs = document.getElementById('imgs');
        bind();
    }
    function bind () {
        $shot.onclick = function (e) {
            $imgs.appendChild(Canvas2Image.convertToImage(canvas, imgW/3, imgH/3, imgType));
        };
        $save.onclick = function (e) {
            var f = 'ShotSave';
            Canvas2Image.saveAsImage(canvas, imgW, imgH, imgType, f);
        }
    }
    onload = init;
</script>

<script>
    var WSURL2 = "ws://" + window.location.host + "/websocket2";
    var ws2 = null;

    var deviceLogsShow = new Vue({
        el: "#logs",
        data: {
            device: {
                logs: '',
            },
        },
    })

    var deviceDetail = new Vue({
        el: "#deviceinfo",
        data: {
            device: {
                name: '',
                udid: '',
                apps: '',
                logs: '',
                type: '',
                version: '',
            },
        },
        mounted: function () {
            this.refresh();
        },
        methods: {
            refresh: function () {
                console.log("getting device info...");
                var self = this;
                $.ajax({
                    url: "/ios/getDeviceInfo?",
                    method: "GET",
                })
                    .then(function (ret) {
                        self.device.udid = ret.udid
                        self.device.name = ret.name
                        self.device.apps = ret.apps
                        self.device.type = ret.type
                        self.device.version = ret.version
                        console.log(udid)
                        var typeString = self.device.type
                        var realTypeName = iosinfo[typeString]["iPhoneType"]
                        console.log(realTypeName)
                        document.getElementById('deviceTypeName').textContent = realTypeName
                        imgX = iosinfo[typeString]["ptX"]
                        imgY = iosinfo[typeString]["ptY"]
                    })
            },
        },
    });

    function refreshdetail() {
        console.log("getting device info...");
        var self = this;
        $.ajax({
            url: "/ios/getDeviceInfo?",
            method: "GET",
        })
            .then(function (ret) {
                deviceDetail.device.udid = ret.udid
                deviceDetail.device.name = ret.name
                deviceDetail.device.apps = ret.apps
                deviceDetail.device.type = ret.type
                deviceDetail.device.version = ret.version
                console.log(udid)
                var typeString = deviceDetail.device.type
                var realTypeName = iosinfo[typeString]["iPhoneType"]
                console.log(realTypeName)
                document.getElementById('deviceTypeName').textContent = realTypeName
                imgX = iosinfo[typeString]["ptX"]
                imgY = iosinfo[typeString]["ptY"]
            })
    }

    var countTimer = new Vue({
        el: "#countTimer",
        data: {
            record: {
                running: false,
                startTime: 0,
                ticker: null,
                duration: 0,
                prompt: ''
            }
        },
        filters: {
            formatDuration: function (value) {
                function pad2(number) {
                    return (number < 10 ? '0' : '') + number
                }
                var totalSeconds = Math.floor(value / 1000); //"00:00:00"
                var mms = value % 1000;
                var ms = totalSeconds % 60;
                var mm = (totalSeconds - ms) / 60
                return "" + pad2(mm) + " : " + pad2(ms);
            }
        },
        mounted: function () {
            var self = this;
            self.record.startTime = new Date().getTime();
            self.record.ticker = setInterval(function () {
                self.record.duration = new Date().getTime() - self.record.startTime;
            }.bind(self), 1000);
        }
    });

    function ScreenCoordinates(e){
    	var cRect = canvas.getBoundingClientRect();

    	var x = Math.round((e.clientX) - cRect.left);
    	var y = Math.round(e.clientY - cRect.top);

    	var coor = "(" + x + "," + y + ")";
    	  //console.log("Coordinates : "+coor);
    	  document.getElementById("ScreenCoordinates").innerHTML = coor;
   	};

   	function clearCoor() {
   	  document.getElementById("ScreenCoordinates").innerHTML = "(" + 0 + "," + 0 + ")";;
   	};

    function findScreenCoords(mouseEvent){
      var xpos;
      var ypos;
      if (mouseEvent){
        //FireFox
        xpos = mouseEvent.screenX;
        ypos = mouseEvent.screenY;
      }else{
        //IE
        xpos = window.event.screenX;
        ypos = window.event.screenY;
      }
      document.getElementById("screenCoords").innerHTML = xpos + ", " + ypos;
    };

    function refreshlogs() {
        if (document.getElementById('getlogbtn').textContent == "Start log scraping") {
            var id = document.getElementById('filter-bundleid').value
            if (id == "" || id.indexOf(".") == -1) {
                alert("Please enter the bundle id of the filter log!")
                return
            }
            deviceLogsShow.device.logs = "";
            console.log("Start crawling logs...");
            var obj = document.getElementById('logs');
            ws2 = new WebSocket(WSURL2 + "/" + id)
            ws2.onclose = function () {
                console.log('ws2 onclose', arguments)
            }
            ws2.onerror = function () {
                console.log('ws2 onerror', arguments)
            }
            ws2.onmessage = function (message) {
                deviceLogsShow.device.logs += message.data;
                console.log('msg got:' + message.data);
                document.getElementById('logs').value += message.data
                //Whether to automatically scroll at the bottom
                //obj.scrollTop =  obj.scrollHeight;
                var scrollTop = $("#logs")[0].scrollHeight;
                $("#logs").scrollTop(scrollTop);
            }
            ws2.onopen = function () {
                console.log('ws2 onopen', arguments)
                ws2.send(id);
            }
            document.getElementById('getlogbtn').textContent = "Stop log crawling"
        } else {
            ws2.close();
            console.log("Stop crawling logs...");
            document.getElementById('getlogbtn').textContent = "Start log scraping"
        }
    }

    function home() {
        $.ajax({
            url: "/ios/home",
            method: "GET",
        })
            .then(function (ret) {
                console.log(ret);
            })
    }
    function launchApp() {
        var id = document.getElementById('bundleid').value
        if (id != "") {
            $.ajax({
                url: "/ios/launchapp?id=" + id,
                method: "GET",
            })
                .then(function (ret) {
                    console.log(ret);
                })
        }
    }
    function uninstallApp() {
        var id = document.getElementById('uninstallid').value
        if (id != "") {
            $.ajax({
                url: "/ios/uninstall?id=" + id,
                method: "GET",
            })
                .then(function (ret) {
                    console.log(ret);
                })
        }
    }
    function getDeviceInfo() {
        var udid = "";
        $.ajax({
            url: "/ios/getDeviceInfo?",
            method: "GET",
        })
            .then(function (ret) {
                udid = ret.udid
                console.log(udid)
            })
    }
    function sendText() {
        var sendValue = encodeURI(encodeURI(document.getElementById('input').value))
        console.log("Input Text = " + sendValue)
        $.ajax({
            url: "/ios/inputText?value=" + sendValue,
            method: "GET",
        })
            .then(function (ret) {
                console.log(ret);
            })
    }
    function clearText() {
        $.ajax({
            url: "/ios/clear",
            method: "GET",
        })
            .then(function (ret) {
                console.log(ret);
            })
    }
</script>


<script>
    var app = new Vue({
        el: "#screen",
        // delimiters: ["[[", "]]"],
        data: {
            display: {
                width: 0,
                height: 0,
                naturalWidth: 0,
                naturalHeight: 0,
            },
            refreshCount: 0,
            sessionId: null,
            pageHidden: false,
            current: 0,
            inputText: '',
            wsAdmin: null,
            record: {
                running: false,
                startTime: 0,
                ticker: null,
                duration: 0,
                prompt: '',
            },
            records: [{
                name: "20170603-test",
            }]
        },
        filters: {
            formatDuration: function (value) {
                function pad2(number) {
                    return (number < 10 ? '0' : '') + number
                }
                var totalSeconds = Math.floor(value / 1000); //"00:00:00"
                var mms = value % 1000;
                var ms = totalSeconds % 60;
                var mm = (totalSeconds - ms) / 60
                return "" + pad2(mm) + " : " + pad2(ms);
            }
        },
        mounted: function () {
            var self = this;
            this.initTouchListener();
            this.initScreenSize();
            var self = this;
            $("#screen")[0].onload = function (e) {
                var nw = e.target.naturalWidth;
                var nh = e.target.naturalHeight;
                if (nw && nh && self.display.naturalHeight != nh) {
                    self.display.naturalWidth = nw;
                    self.display.naturalHeight = nh;
                    self.initScreenSize();
                    console.log("Detect screen rotate");
                }
            }.bind(this);
        },
        methods: {
            tap: function (x, y) {
            	console.log("tap func");
                var self = this;
                return $.ajax({
                    url: "/ios/tap/?x=" + x + "&y=" + y,
                    method: "GET"
                }).then(function (ret) {
                    if (ret.status !== 0) {
                        console.log("tap fail"+ret.value);
                        return "Fail"
                    } else {
                    	console.log("tap success"+ret.value);
                        return "Success";
                    }
                })
            },
            tapHold: function (x, y, duration) {
                var self = this;
                duration = duration / 1000
                return $.ajax({
                    url: "/ios/tapHold?x=" + x + "&y=" + y + "&duration=" + duration,
                    method: "GET"
                }).then(function (ret) {
                    if (ret.status !== 0) {
                        console.log(ret.value);
                    } else {
                        return "Success";
                    }
                })
            },
            swipe: function (fromX, fromY, toX, toY) {
                var self = this;
                return $.ajax({
                    url: "/ios/swipe?fromX=" + fromX + "&fromY=" + fromY + "&toX=" + toX + "&toY=" + toY + "&duration=" + 0.08,
                    method: "GET"
                })
            },
            home: function () {
                return $.ajax({
                    url: "/ios/homeScreen",
                    method: "GET"
                }).then(function (ret) {
                    console.log(ret);
                })
            },
            sendText: function (text) {
                inputText = document.getElementById('input').value
                return $.ajax({
                    url: "/ios/inputText?value=" + inputText,
                    method: "GET"
                }).then(function (ret) {
                    console.log(ret);
                })
            },
            clearText: function (n) {
                this.sendText("\b".repeat(n || 30))
            },
            initScreenSize: function () {
                $.ajax({
                    url: "/status",
                })
                    .then(function (ret) {
                        this.sessionId = ret.sessionId;
                        Object.assign(this.device, ret.value.device);
                        return $.ajax({
                            url: "/session/" + ret.sessionId + "/window/size",
                        })
                    }.bind(this))
                    .then(function (ret) {
                        this.display.width = ret.value.width;
                        this.display.height = ret.value.height;
                    }.bind(this))
            },

            initTouchListener: function () {
                var self = this;
                var element = $("#screen")[0];
                var screen = {
                    bounds: {},
                    firstPosition: {},
                    secondPosition: {},
                    beginTime: null,
                }
                var _longClickTimeout = 800;
//                function calculateBounds() {
//                    var el = element;
//                    screen.bounds.w = el.offsetWidth
//                    screen.bounds.h = el.offsetHeight
//                    screen.bounds.x = 0
//                    screen.bounds.y = 0
//
//                    while (el.offsetParent) {
//                        screen.bounds.x += el.offsetLeft
//                        screen.bounds.y += el.offsetTop
//                        el = el.offsetParent
//                    }
//                }
                function deactiveFinger(index) {
                    $(".finger-" + index).removeClass("active").removeClass("longClick")
                }
                function convertPosition(event) {
                    var e = event;
                    if (e.originalEvent) {
                        e = e.originalEvent
                    }
                    // Ignore mouse right click
                    if (e.which === 3) {
                        return;
                    }
                    e.preventDefault()
//                    calculateBounds()
                    var x = e.offsetX //+ 30
                    var y = e.offsetY
                    console.log("convertPosition x: " + x + ", convertPosition y: " + e.offsetY)
                    var convert =  {
                        e: e,
                        x: x,
                        y: y,
                        pageX: x,
                        pageY: y,
                    }
                    console.log(convert);
                    return convert;
                }
                function stopMousing() {
                    element.removeEventListener('mousemove', mouseMoveListener);
                    document.removeEventListener('mouseup', mouseUpListener);
                }

                function mouseUpListener(event) {
                    var p = convertPosition(event);
                    console.log("X: "+p.pageX +"Y : "+p.pageY);
                    stopMousing()
                    var first = screen.firstPosition,
                        second = screen.secondPosition;
                    screen.secondPosition = {};
                    element.style.cursor = 'not-allowed'
                    clearTimeout(screen.longClickKey);
                    var defer;
                    if (second && (second.x || second.y)) {
                        console.log("Swipe", first, second);
                        defer = self.swipe(first.x, first.y, second.x, second.y);
                    } else {
                        var holdTime = new Date().getTime() - screen.beginTime;
                        if (holdTime > _longClickTimeout) {
                            console.log("LongTap", first);
                            defer = self.tapHold(first.x, first.y, holdTime)
                        } else {
                            console.log("Tap", first);
                            defer = self.tap(first.x, first.y)
                        }
                    }
                    defer.then(function () {
                        console.log("Release operation")
                        deactiveFinger(0);
                        deactiveFinger(1);
                        element.style.cursor = 'auto'
                    })
                }
                function mouseMoveListener(event) {
                	 console.log("in mouseMoveListener");
                    var p = convertPosition(event);
                    var first = screen.firstPosition;
                    var distance = Math.sqrt((first.x - p.x) * (first.x - p.x) + (first.y - p.y) * (first.y - p.y));
                    if (distance > 10) {
                        screen.secondPosition = {
                            x: p.x,
                            y: p.y
                        };
                        console.log("in mouseMoveListener printing co-ordinates"+p);
                        $(".finger-1")
                            .addClass("active")
                            .css("transform", 'translate3d(' + p.pageX + 'px,' + p.pageY + 'px,0)')
                    } else {
                        deactiveFinger("1");
                        screen.secondPosition = {};
                    }
                }
                function mouseDownListener(event) {
                    if (element.style.cursor == 'not-allowed') {
                        return;
                    }
                    var p = convertPosition(event);
                    var index = 0;
                    $(".finger-" + index)
                        .addClass("active")
                        .css("transform", 'translate3d(' + p.pageX + 'px,' + p.pageY + 'px,0)')
                    screen.longClickKey = setTimeout(function () {
                        $(".finger-0").addClass("longClick");
                    }, _longClickTimeout)
                    screen.beginTime = new Date().getTime();
                    screen.firstPosition = {
                        x: p.x,
                        y: p.y
                    }
                    element.addEventListener('mousemove', mouseMoveListener);
                    document.addEventListener('mouseup', mouseUpListener);
                }
                element.addEventListener("mousedown", mouseDownListener);
            }
        }
    })
</script>

<script type="text/javascript">
    function upload() {
        var file = document.getElementById("uploadfile");
        var fileInfo = file.files[0];
        console.log(fileInfo);
        if (!fileInfo) {
            alert("Please select a file!");
            return false;
        }
        var fileName = fileInfo.name;
        //Get the file extension
        var file_typename = fileName.substring(
            fileName.lastIndexOf('.') + 1, fileName.length);
        if (file_typename.toLowerCase() != 'ipa') {
            alert("Please upload .ipa type files!");
            return false;
        }
        try {
            $.ajaxFileUpload({
                url: '/ios/upload',   //Submitted path
                type: 'post',
                secureuri: false, //Whether to enable secure submission, the default is false
                fileElementId: 'uploadfile', // file control id
                dataType: 'json',
                data: {},
                success: function (data, status) {
                    console.log(data);
                    console.log(status);
                },
                error: function (data, status) {
                    alert("upload failed");
                }
            });
        } catch (err) {
            alert("Please upload the .ipa file, do not upload other types!" + err.message);
        }
    }
</script>

<script>

    var WSURL = "ws://" + window.location.host + "/websocket"

    function createTable(){
    	var headers = device.apps.split(',');
    	var table = "<table>";
    	for (var i=0; i< headers.length; i++) {
    	    table = table + "<tr><td>"+ headers[i]+"</td>";
    	}
    	table = table + "</table>";

    	return table;
    }

    ws.onerror = function () {
        console.log('onerror', arguments)
        renderLoop.stop()
    }
    ws.onmessage = function (message) {
        //console.log('got jpeg', arguments)
        var blob = new Blob([message.data], {
            type: 'image/jpeg'
        })
        pipeline.push(blob)
    }
    ws.onopen = function () {
        console.log('onopen', arguments)
        ws.send('1920x1080/0')
        renderLoop.start()
    }
</script>

</body>
</html>
